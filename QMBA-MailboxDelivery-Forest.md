# QMBA-MailboxDelivery-Forest

Monday, September 24, 2018

10:32 AM

| Monitor  Goal                                                | **Investigation  Goal**                                      | Owner   |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------- |
| Alert when normal priority messages across a forest have been queued for mailbox delivery for too long. | Messages queued for mailbox delivery will likely be dispersed across the entire forest.  Attempt to find out why the old ones cannot be delivered to a mailbox or de-prioritized | frankby |

## What triggers the alert?

This signal for this alert is generated by the MailboxDeliveryQmbaProbe, which periodically measures the value of the MSExchangeTransport Queued Messages By Age / Internal Mailbox Delivery Normal Priority / \>1hr performance counter and uploads its value to Geneva. The alert threshold is forest level is 1000.

A Geneva dashboard providing current and recent historical views of this data by time, forest, and availability group is available on the IPTransport account. There is also a link at the bottom of the Alert e-mail.

[QMBA dash board link](https://jarvis-west.dc.ad.msft.net/dashboard/share/91E7368C?overrides=%5b%7b%22query%22:%22//*%5bid='Environment'%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid='Region'%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid='Forest'%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid='AvailabilityGroup'%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid='Machine'%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d%5d%20)

![qmba](/Users/keshihua/Desktop/microsoft interview docs/qmba.png)

## Possible root causes

1.  Hot delivery, single delivery server has the issue. All queued messages are targeting the same delivery server.

2.  Hot hub, single hub server can\'t send messages out. Probably Auth issue. All queued messages are in the same hub server.

3.  Scattered hub and scattered delivery. Some special messages have some pattern got queued.

4.  Networking failure, café failure.

## Diagnose and Recovery

1.  Once you got the alert, please open the [QMBA dash board link](https://jarvis-west.dc.ad.msft.net/dashboard/share/91E7368C?overrides=%5b%7b%22query%22:%22//*%5bid='Environment'%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid='Region'%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid='Forest'%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid='AvailabilityGroup'%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d,%7b%22query%22:%22//*%5bid='Machine'%5d%22,%22key%22:%22value%22,%22replacement%22:%22%22%7d%5d%20) to get the latest queue status. Please change this alert\'s urgency to Sev3 in alerting forest while you are investigating.

2.  Run Transport on-call script Diagnose-QRBA.ps1.

    a.  If the script point to single delivery server. Please move mailbox database out for that delivery server.

    b.  Run check-deliveryhealth.sp1, in the \"MDB Health Summary\" session, If the a mdb\'s MDBHealth is low and WorestREsource is DiskLatency, engage HA team. In the \"MDB Throttling Summary\" session, If many messages are throttled by Disklatency, engage HA team.

    c.  Please check provision status for that delivery server, we ever met delivery server is in MM but there still has mdb mounted on it.

    d.  You can refer this playbook([HttpDeliveryAvailabilityV2Monitor](onenote:#HttpDeliveryAvailabilityV2Monitor&section-id={F0A9DD2C-8D88-4246-9561-12B4E91CFA0A}&page-id={AF6CA10D-662C-41AA-B2F0-6E94B741AFAC}&end&base-path=https://microsoft.sharepoint-df.com/teams/O365TransportTeam/SiteAssets/O365%20Transport%20Team%20Notebook/Alert%20Playbook.one)) to diagnose single delivery issue.

3. In **ITAR** environment, Diagnose-QRBA.ps1 can\'t be ran, please ask Escort run below two commands to find hot delivery server.

   `Get-QueueDiversityV2 -forest //It will list top target mdb-\> \$mdbGuid`

   `Get-MailboxDatabase \$mdbGuid //Find where this mdb mounted`

4. Check Geneva dashboard, in the \"Top Machines\" chart which is the top queued hub server, if top machine\'s queued message count is close to forest queued messages count, we can say this is hot hub issue.

   a.  Get last error of queue messages. You can know why messages were deferred in the delivery queue.

   `$q = get-queue -Server BN3PR00MB0178 -Filter \"DeliveryType -eq \'HttpDeliveryToExo`

   `$msg= get-message -Queue \$q.Identity`

   `$msg.LastError`

   b.  Please download **HubTransportHttpSendLogsHourly** in hub server to check more detail for the last error.

   `Get-MachineLog -target \$server -Log HubTransportHttpSendLogsHourly`

   c.  Restart MSExchangeTransport to mitigate first.

   `Request-RestartService_V2.ps1 **-Target** \$server **-ServiceName**` 

   `MSExchangeTransport **-Reason** \"reason\"`

5. If neither hot delivery nor hot hub.

   There may some special messages have some pattern got queued.

   a.  Check messages that queued in delivery queue, check last error to see these queued messages have some pattern or not.

   `Get-QueueDiversityV2 -Forest -Priority normal -QueueFilter {DeliveryType -eq \'HttpDeliveryToExo\'} -MinMessageLatency \"01:00:00\"`

   b.  Check delivery [hang dashboard](<https://jarvis-west.dc.ad.msft.net/dashboard/O365_Transport/MailboxTransport/Delivery/DeliveryHangException>), to see in the alerting forest delivery hang status, if hang exception increasing a lot, it may cause other normal messages queued. 

   Please engage other team based on hang call stack. Mitigation action maybe drop the messages that cause delivery hang, you can check the message id to find message\'s common pattern.